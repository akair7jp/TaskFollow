<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFollow - タスク管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; color: #1e293b; }
        .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; z-index: 100; }
        .show { display: block !important; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border-radius: 0.5rem; overflow: hidden; }
        .calendar-day { background-color: white; min-height: 100px; padding: 0.5rem; }
        .view-btn-active { background-color: white !important; color: #4f46e5 !important; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .task-card { transition: all 0.2s; border: 1px solid #f1f5f9; }
        .task-card:hover { border-color: #e2e8f0; transform: translateY(-1px); }
        input[type="date"] { border-radius: 0.5rem; padding: 0.5rem; border: 1px solid #e2e8f0; }
    </style>
</head>
<body onclick="closeAllMenus()">

    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4 bg-slate-100">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md border border-gray-100">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-extrabold text-indigo-600">TaskFollow</h1>
                <p id="auth-subtitle" class="text-gray-400 text-sm mt-2">あなたのタスクを整理して、効率的に管理しましょう</p>
            </div>
            
            <form id="auth-form" class="space-y-4" onsubmit="handleAuth(event)">
                <div id="reg-fields" class="hidden space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">メールアドレス *</label>
                        <input type="email" id="auth-email" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">電話番号 (忘却用) *</label>
                        <input type="tel" id="auth-tel" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ログインID (英数字・記号)</label>
                    <input type="text" id="auth-userid" required pattern="^[a-zA-Z0-9!-/:-@[-`{-~]+$" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">パスワード</label>
                    <input type="password" id="auth-pw" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <div id="reg-confirm-field" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 mb-1">パスワード (再確認)</label>
                    <input type="password" id="auth-pw-confirm" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <button type="submit" id="auth-submit-btn" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">ログイン</button>
            </form>

            <div class="mt-6 flex flex-col items-center gap-4">
                <div class="text-gray-300 text-xs flex items-center gap-2 w-full"><hr class="flex-1"><span>または</span><hr class="flex-1"></div>
                <div id="g_id_onload" data-client_id="421400998994-4ntocml0q8gj6th77d9luhdrf4sfai53.apps.googleusercontent.com" data-callback="handleGoogleAuth"></div>
                <div class="g_id_signin" data-type="standard" data-text="signin_with" data-shape="rectangular" data-logo_alignment="left"></div>
                <button onclick="toggleAuthMode()" id="auth-toggle-btn" class="text-sm font-bold text-gray-400 hover:text-indigo-600">新規アカウント作成</button>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden p-4 md:p-10 max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">タスク管理</h1>
                <p class="text-gray-400 text-sm">あなたのタスクを整理して、効率的に管理しましょう</p>
                <div class="relative mt-2">
                    <button onclick="toggleUserDropdown(event)" class="text-gray-700 font-bold text-sm flex items-center gap-1 hover:text-indigo-600 transition">
                        <span id="display-user-name"></span>さん <i class="fa-solid fa-chevron-down text-[10px]"></i>
                    </button>
                    <div id="user-dropdown" class="dropdown-menu bg-white shadow-2xl border border-gray-100 rounded-xl py-2 w-56 mt-2 left-0">
                        <button onclick="openUserEditModal('email')" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 flex items-center gap-2"><i class="fa-solid fa-envelope w-4 text-gray-400"></i>メールアドレス変更</button>
                        <button onclick="openUserEditModal('tel')" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 flex items-center gap-2"><i class="fa-solid fa-phone w-4 text-gray-400"></i>電話番号変更</button>
                        <button onclick="openUserEditModal('pw')" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-50 flex items-center gap-2"><i class="fa-solid fa-key w-4 text-gray-400"></i>パスワード変更</button>
                        <div class="px-4 py-2 mt-1 border-t border-gray-50 text-[10px] text-gray-400 font-bold">ログインID: <span id="info-id"></span></div>
                        <hr class="my-1">
                        <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-50 font-bold flex items-center gap-2"><i class="fa-solid fa-right-from-bracket w-4"></i>ログアウト</button>
                    </div>
                </div>
            </div>
            <div id="user-controls" class="flex flex-wrap gap-2">
                <button onclick="toggleConfigModal()" class="bg-white border px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-50"><i class="fa-solid fa-gear"></i> 設定</button>
                <button onclick="toggleImportModal()" class="bg-white border px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-50"><i class="fa-solid fa-file-import"></i> インポート</button>
                <button onclick="toggleBulkInputModal()" class="bg-white border px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-50"><i class="fa-solid fa-list-check"></i> 一括登録</button>
                <button onclick="openTaskModal()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-md"><i class="fa-solid fa-plus"></i> 新規タスク</button>
            </div>
        </div>

        <div id="admin-panel" class="hidden mb-8 bg-white rounded-2xl border border-red-100 shadow-sm overflow-hidden">
            <div class="p-5 border-b bg-red-50/30 flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="font-bold text-gray-700 flex items-center gap-2"><i class="fa-solid fa-user-shield text-red-500"></i> 管理者パネル</h2>
                <div class="relative w-full md:w-80">
                    <input type="text" id="admin-search" oninput="renderAdminUsers()" placeholder="ID, メアド, 電話番号で検索" class="w-full pl-4 pr-10 py-2 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-red-400">
                    <button onclick="clearAdminSearch()" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-red-500 font-bold text-lg">×</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-gray-400 text-[10px] font-black uppercase tracking-widest">
                        <tr><th class="p-4">ログインID</th><th class="p-4">メールアドレス</th><th class="p-4">電話番号</th><th class="p-4 text-right">操作</th></tr>
                    </thead>
                    <tbody id="admin-user-list"></tbody>
                </table>
            </div>
        </div>

        <div id="user-main-content">
            <div id="stats-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8"></div>
            
            <div id="bulk-action-bar" class="hidden mb-6 p-4 bg-indigo-600 rounded-2xl flex items-center justify-between shadow-lg">
                <div class="flex items-center gap-4">
                    <button onclick="selectAllTasks()" class="bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-400">すべて選択</button>
                    <span class="text-white text-sm font-bold"><span id="selected-count">0</span> 件選択中</span>
                </div>
                <div class="flex gap-2">
                    <select id="bulk-status-select" onchange="bulkUpdateStatus(this.value)" class="text-xs rounded-lg px-3 py-2 font-bold outline-none">
                        <option value="">状態変更</option><option value="todo">未着手</option><option value="doing">進行中</option><option value="done">完了</option>
                    </select>
                    <button onclick="bulkDuplicate()" class="text-xs bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold">一括複製</button>
                    <button onclick="bulkDelete()" class="text-xs bg-red-500 text-white px-4 py-2 rounded-lg font-bold">一括削除</button>
                </div>
            </div>

            <div class="mb-6 space-y-4">
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" oninput="applyFilters()" placeholder="タスクを検索..." class="w-full pl-12 pr-12 py-3 rounded-xl border border-gray-200 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex flex-wrap items-center gap-3">
                        <select id="filter-status" onchange="applyFilters()" class="bg-white border rounded-lg px-3 py-1.5 text-sm font-medium outline-none"></select>
                        <select id="filter-priority" onchange="applyFilters()" class="bg-white border rounded-lg px-3 py-1.5 text-sm font-medium outline-none">
                            <option value="all">全優先度</option><option value="高">高</option><option value="中">中</option><option value="低">低</option>
                        </select>
                        <select id="filter-category" onchange="applyFilters()" class="bg-white border rounded-lg px-3 py-1.5 text-sm font-medium outline-none"></select>
                        <select id="sort-order" onchange="applyFilters()" class="bg-white border rounded-lg px-3 py-1.5 text-sm font-bold outline-none text-indigo-600">
                            <option value="priority">優先度順</option><option value="date">期限順</option>
                        </select>
                    </div>
                    <div class="bg-gray-200 p-1 rounded-xl flex shadow-inner">
                        <button id="view-list-btn" onclick="switchView('list')" class="view-btn-active px-4 py-1.5 rounded-lg text-sm font-bold">リスト</button>
                        <button id="view-calendar-btn" onclick="switchView('calendar')" class="px-4 py-1.5 rounded-lg text-sm font-bold text-gray-400">カレンダー</button>
                    </div>
                </div>
            </div>

            <div id="list-view-container" class="grid grid-cols-1 gap-3"></div>
            <div id="calendar-view-container" class="hidden bg-white p-4 rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                <div id="calendar-header" class="flex justify-between items-center mb-4 font-bold text-gray-700 px-2"></div>
                <div class="calendar-grid" id="calendar-body"></div>
            </div>
            <div id="empty-state" class="hidden py-20 text-center text-gray-300 font-bold">タスクが見つかりません</div>
        </div>
    </div>

    <div id="modal-task" class="fixed inset-0 bg-black/40 z-[200] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center"><h2 id="task-modal-title" class="text-xl font-bold">タスク作成</h2><button onclick="closeModal('modal-task')" class="text-gray-400 text-2xl">&times;</button></div>
            <form id="task-form" class="p-6 space-y-4" onsubmit="saveTask(event)">
                <input type="hidden" id="edit-id">
                <input type="text" id="task-title" required placeholder="タスク名を入力..." class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                <div class="grid grid-cols-2 gap-4">
                    <select id="task-priority" class="p-3 border rounded-xl bg-white outline-none"><option value="高">優先度: 高</option><option value="中" selected>優先度: 中</option><option value="低">優先度: 低</option></select>
                    <select id="task-category-select" class="p-3 border rounded-xl bg-white outline-none"></select>
                </div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <label class="flex items-center gap-2 mb-3 cursor-pointer">
                        <input type="checkbox" id="task-date-enabled" checked onchange="toggleDateInput(this.checked)" class="w-4 h-4">
                        <span class="text-xs font-bold text-gray-600">期限を設ける</span>
                    </label>
                    <div id="date-inputs" class="space-y-2">
                        <div class="flex flex-col">
                            <span class="text-[10px] text-gray-400 mb-1 font-bold">スマート入力 (MMDD)</span>
                            <input type="text" id="task-date-smart" placeholder="例: 0520" maxlength="4" class="p-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500" oninput="syncSmartToDate(this.value)">
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] text-gray-400 mb-1 font-bold">カレンダーから選択</span>
                            <input type="date" id="task-date-picker" class="w-full" onchange="syncPickerToSmart(this.value)">
                        </div>
                    </div>
                </div>
                <textarea id="task-desc" placeholder="詳細メモ..." class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>
                <div class="flex gap-2"><button type="button" onclick="closeModal('modal-task')" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold">キャンセル</button><button type="submit" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">保存</button></div>
            </form>
        </div>
    </div>

    <div id="modal-import" class="fixed inset-0 bg-black/40 z-[200] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-2">インポート</h2>
            <p class="text-xs text-gray-400 mb-4 font-medium">CSVまたはJSON形式 (上限10MB)<br>CSV例: タイトル,内容,優先度,カテゴリ,YYYY-MM-DD</p>
            <input type="file" id="file-import-input" accept=".csv,.json" class="mb-6 text-sm w-full">
            <button onclick="closeModal('modal-import')" class="w-full py-3 bg-gray-100 rounded-xl font-bold">閉じる</button>
        </div>
    </div>

    <div id="modal-bulk" class="fixed inset-0 bg-black/40 z-[200] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-xl rounded-2xl p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-2">一括登録</h2>
            <p class="text-xs text-gray-400 mb-4 bg-gray-50 p-3 rounded-lg border font-bold">形式: タイトル, 説明, 優先度(高/中/低), カテゴリ, MMDD (空欄orなしで期限なし)</p>
            <textarea id="bulk-typing-area" rows="6" placeholder="タイトル,説明,優先度,カテゴリ,MMDD" class="w-full p-4 border rounded-xl mb-4 font-mono text-sm outline-none bg-slate-50"></textarea>
            <div class="flex gap-3"><button onclick="closeModal('modal-bulk')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">キャンセル</button><button onclick="processBulkInput()" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">登録実行</button></div>
        </div>
    </div>

    <div id="modal-user-edit" class="fixed inset-0 bg-black/40 z-[300] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h2 id="user-edit-title" class="text-xl font-bold mb-4 text-indigo-600">設定変更</h2>
            <input id="user-edit-input" class="w-full p-3 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-indigo-500">
            <div class="flex gap-3"><button onclick="closeModal('modal-user-edit')" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">中止</button><button onclick="saveUserEdit()" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">更新する</button></div>
        </div>
    </div>

    <div id="modal-config" class="fixed inset-0 bg-black/40 z-[200] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-indigo-600">カテゴリー管理</h2>
            <div class="flex gap-2 mb-4"><input type="text" id="new-cat-input" class="flex-1 p-2 border rounded-lg outline-none" placeholder="新規"><button onclick="addCategory()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold">追加</button></div>
            <div id="cat-list-container" class="space-y-2 mb-6 max-h-40 overflow-y-auto"></div>
            <button onclick="closeModal('modal-config')" class="w-full py-2 bg-gray-100 rounded-lg font-bold">閉じる</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        let tasks = [];
        let categories = ['仕事', '個人'];
        let selectedTaskIds = new Set();
        let currentView = 'list';
        let isRegistrationMode = false;
        let currentEditingField = '';

        // --- 認証 ---
        const DB_KEY = 'tf_users_database_v2';
        function toggleAuthMode() {
            isRegistrationMode = !isRegistrationMode;
            document.getElementById('reg-fields').classList.toggle('hidden', !isRegistrationMode);
            document.getElementById('reg-confirm-field').classList.toggle('hidden', !isRegistrationMode);
            document.getElementById('auth-subtitle').innerText = isRegistrationMode ? 'アカウントを作成しましょう' : 'あなたのタスクを整理して、効率的に管理しましょう';
            document.getElementById('auth-submit-btn').innerText = isRegistrationMode ? 'アカウントを作成する' : 'ログイン';
            document.getElementById('auth-toggle-btn').innerText = isRegistrationMode ? 'ログイン画面へ戻る' : '新規アカウント作成';
        }

        function handleAuth(e) {
            e.preventDefault();
            const db = JSON.parse(localStorage.getItem(DB_KEY) || '{"Admin":{"pw":"Admin","email":"admin@taskfollow.jp","tel":"000-0000-0000","history":{}}}');
            const uid = document.getElementById('auth-userid').value.trim();
            const pw = document.getElementById('auth-pw').value;

            if (isRegistrationMode) {
                const email = document.getElementById('auth-email').value;
                const tel = document.getElementById('auth-tel').value;
                const pwConfirm = document.getElementById('auth-pw-confirm').value;
                if(!email || !tel) return alert("必須項目を入力してください");
                if(pw !== pwConfirm) return alert("パスワードが一致しません");
                if(db[uid]) return alert("このIDは既に使用されています");
                db[uid] = { pw, email, tel, history: {} };
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                alert("登録完了！ログインしてください"); toggleAuthMode();
            } else {
                if(db[uid] && db[uid].pw === pw) { login(uid); }
                else { alert("IDまたはパスワードが違います"); }
            }
        }

        function handleGoogleAuth(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            const db = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
            const uid = payload.email.split('@')[0];
            if(!db[uid]) {
                db[uid] = { pw: "GOOGLE_LINKED", email: payload.email, tel: "Google連携", history: {} };
                localStorage.setItem(DB_KEY, JSON.stringify(db));
            }
            login(uid);
        }

        function login(uid) {
            currentUser = uid;
            localStorage.setItem('tf_active_session', uid);
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('display-user-name').innerText = uid;
            document.getElementById('info-id').innerText = uid;

            if (uid === 'Admin') {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('user-main-content').classList.add('hidden');
                document.getElementById('user-controls').classList.add('hidden');
                renderAdminUsers();
            } else {
                const data = JSON.parse(localStorage.getItem(`tf_data_${uid}`) || '{"tasks":[],"categories":["仕事","個人"]}');
                tasks = data.tasks; categories = data.categories;
                updateCategoryUI(); applyFilters();
            }
        }

        function logout() { localStorage.removeItem('tf_active_session'); location.reload(); }

        // --- Admin機能 ---
        function renderAdminUsers() {
            const db = JSON.parse(localStorage.getItem(DB_KEY) || '{}');
            const query = document.getElementById('admin-search').value.toLowerCase();
            const list = document.getElementById('admin-user-list');
            list.innerHTML = '';
            Object.keys(db).forEach(uid => {
                if (uid === 'Admin') return;
                const u = db[uid];
                if (uid.toLowerCase().includes(query) || u.email.toLowerCase().includes(query) || u.tel.includes(query)) {
                    const hMail = u.history.email ? `<div class="text-[9px] text-gray-400 font-bold">前: ${u.history.email}</div>` : '';
                    const hTel = u.history.tel ? `<div class="text-[9px] text-gray-400 font-bold">前: ${u.history.tel}</div>` : '';
                    const hId = u.history.id ? `<div class="text-[9px] text-gray-400 font-bold">前: ${u.history.id}</div>` : '';
                    list.innerHTML += `<tr class="border-b hover:bg-slate-50">
                        <td class="p-4 font-bold text-indigo-600">${uid}${hId}</td>
                        <td class="p-4 text-xs">${u.email}${hMail}</td>
                        <td class="p-4 text-xs">${u.tel}${hTel}</td>
                        <td class="p-4 text-right"><button onclick="adminDeleteUser('${uid}')" class="bg-red-50 text-red-500 px-3 py-1 rounded-lg font-bold">削除</button></td>
                    </tr>`;
                }
            });
        }
        function clearAdminSearch() { document.getElementById('admin-search').value = ''; renderAdminUsers(); }
        function adminDeleteUser(uid) { if(confirm(`${uid}を削除しますか？`)) { const db = JSON.parse(localStorage.getItem(DB_KEY)); delete db[uid]; localStorage.setItem(DB_KEY, JSON.stringify(db)); renderAdminUsers(); }}

        // --- ユーザー設定変更 ---
        function openUserEditModal(f) {
            currentEditingField = f;
            const titles = { email: 'メアド変更', tel: '電話番号変更', pw: 'パスワード変更' };
            document.getElementById('user-edit-title').innerText = titles[f];
            document.getElementById('user-edit-input').value = '';
            document.getElementById('modal-user-edit').classList.remove('hidden');
        }
        function saveUserEdit() {
            const val = document.getElementById('user-edit-input').value.trim();
            if(!val) return;
            const db = JSON.parse(localStorage.getItem(DB_KEY));
            if(currentEditingField !== 'pw') db[currentUser].history[currentEditingField] = db[currentUser][currentEditingField];
            db[currentUser][currentEditingField] = val;
            localStorage.setItem(DB_KEY, JSON.stringify(db)); alert("更新完了"); closeModal('modal-user-edit');
        }

        // --- タスク操作 ---
        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const stat = document.getElementById('filter-status').value || 'all';
            const prio = document.getElementById('filter-priority').value;
            const cat = document.getElementById('filter-category').value;
            const sort = document.getElementById('sort-order').value;

            let filtered = tasks.filter(t => (t.title.toLowerCase().includes(search)) && (stat === 'all' || t.status === stat) && (prio === 'all' || t.priority === prio) && (cat === 'all' || t.category === cat));
            
            const pMap = { '高': 1, '中': 2, '低': 3 };
            filtered.sort((a, b) => {
                if(sort === 'priority') {
                    const diff = pMap[a.priority] - pMap[b.priority];
                    if(diff !== 0) return diff;
                    return (a.date || '9999-99-99') > (b.date || '9999-99-99') ? 1 : -1;
                }
                return (a.date || '9999-99-99') > (b.date || '9999-99-99') ? 1 : -1;
            });

            renderTasks(filtered);
            if(currentView === 'calendar') renderCalendar(filtered);
            updateStats(); saveUserData();
        }

        function renderTasks(data) {
            const container = document.getElementById('list-view-container'); container.innerHTML = '';
            document.getElementById('empty-state').classList.toggle('hidden', data.length > 0);
            data.forEach(t => {
                const isSelected = selectedTaskIds.has(t.id) ? 'checked' : '';
                container.innerHTML += `
                    <div class="task-card bg-white p-5 rounded-2xl flex items-start gap-4 shadow-sm relative">
                        <input type="checkbox" ${isSelected} onchange="toggleTaskSelection(${t.id})" class="mt-1.5 w-5 h-5 cursor-pointer accent-indigo-600">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-lg mb-2 truncate">${t.title}</h3>
                            <div class="flex flex-wrap gap-2 text-[11px] font-bold mb-4">
                                <span class="px-2 py-1 rounded bg-slate-100 flex items-center gap-1"><i class="fa-solid fa-flag ${t.priority==='高'?'text-red-500':t.priority==='中'?'text-amber-500':'text-emerald-500'}"></i>${t.priority}</span>
                                <span class="px-2 py-1 rounded bg-indigo-50 text-indigo-600">${t.category}</span>
                                <span class="px-2 py-1 rounded bg-slate-100 flex items-center gap-1"><i class="fa-regular fa-clock"></i>${t.date || '期限なし'}</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="quickStatus(${t.id}, 'todo')" class="text-[10px] font-bold px-3 py-1.5 rounded-lg border ${t.status==='todo'?'bg-amber-500 text-white':'bg-white text-gray-400'}">未着手</button>
                                <button onclick="quickStatus(${t.id}, 'doing')" class="text-[10px] font-bold px-3 py-1.5 rounded-lg border ${t.status==='doing'?'bg-blue-500 text-white':'bg-white text-gray-400'}">進行中</button>
                                <button onclick="quickStatus(${t.id}, 'done')" class="text-[10px] font-bold px-3 py-1.5 rounded-lg border ${t.status==='done'?'bg-emerald-500 text-white':'bg-white text-gray-400'}">完了</button>
                            </div>
                        </div>
                        <button onclick="toggleMenu(event, ${t.id})" class="text-gray-300 p-2"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                        <div id="menu-${t.id}" class="dropdown-menu bg-white shadow-xl border rounded-xl py-2 w-32 right-6 absolute top-12">
                            <button onclick="editTask(${t.id})" class="w-full text-left px-4 py-2 text-xs hover:bg-slate-50 font-bold"><i class="fa-solid fa-pen mr-2"></i>編集</button>
                            <button onclick="duplicateTask(${t.id})" class="w-full text-left px-4 py-2 text-xs hover:bg-slate-50 font-bold"><i class="fa-solid fa-copy mr-2"></i>複製</button>
                            <button onclick="deleteTask(${t.id})" class="w-full text-left px-4 py-2 text-xs text-red-500 hover:bg-red-50 font-bold"><i class="fa-solid fa-trash mr-2"></i>削除</button>
                        </div>
                    </div>`;
            });
        }

        // --- 期限入力ロジック ---
        function toggleDateInput(enabled) {
            const inputs = document.getElementById('date-inputs');
            inputs.style.opacity = enabled ? "1" : "0.3";
            document.getElementById('task-date-smart').disabled = !enabled;
            document.getElementById('task-date-picker').disabled = !enabled;
            if(!enabled) {
                document.getElementById('task-date-smart').value = '';
                document.getElementById('task-date-picker').value = '';
            }
        }
        function syncSmartToDate(val) {
            if(val.length === 4) {
                const year = new Date().getFullYear();
                const d = `${year}-${val.substring(0,2)}-${val.substring(2,4)}`;
                document.getElementById('task-date-picker').value = d;
            }
        }
        function syncPickerToSmart(val) {
            if(val) {
                const parts = val.split('-');
                document.getElementById('task-date-smart').value = parts[1] + parts[2];
            }
        }

        // --- 一括操作 ---
        function selectAllTasks() {
            tasks.forEach(t => selectedTaskIds.add(t.id));
            updateBulkUI(); applyFilters();
        }
        function toggleTaskSelection(id) {
            selectedTaskIds.has(id) ? selectedTaskIds.delete(id) : selectedTaskIds.add(id);
            updateBulkUI();
        }
        function updateBulkUI() {
            document.getElementById('selected-count').innerText = selectedTaskIds.size;
            document.getElementById('bulk-action-bar').classList.toggle('hidden', selectedTaskIds.size === 0);
        }
        function bulkDelete() { if(confirm('削除しますか？')) { tasks = tasks.filter(t => !selectedTaskIds.has(t.id)); selectedTaskIds.clear(); updateBulkUI(); applyFilters(); }}
        function bulkDuplicate() { tasks.forEach(t => { if(selectedTaskIds.has(t.id)) tasks.push({...t, id: Date.now()+Math.random(), title: t.title + ' (コピー)'}) }); selectedTaskIds.clear(); updateBulkUI(); applyFilters(); }
        function bulkUpdateStatus(s) { if(!s) return; tasks.forEach(t => { if(selectedTaskIds.has(t.id)) t.status = s }); selectedTaskIds.clear(); updateBulkUI(); applyFilters(); }

        // --- カレンダー描画 ---
        function switchView(view) {
            currentView = view;
            document.getElementById('list-view-container').classList.toggle('hidden', view === 'calendar');
            document.getElementById('calendar-view-container').classList.toggle('hidden', view === 'list');
            document.getElementById('view-list-btn').classList.toggle('view-btn-active', view === 'list');
            document.getElementById('view-calendar-btn').classList.toggle('view-btn-active', view === 'calendar');
            applyFilters();
        }
        function renderCalendar(data) {
            const body = document.getElementById('calendar-body'); body.innerHTML = '';
            const now = new Date(); const year = now.getFullYear(); const month = now.getMonth();
            document.getElementById('calendar-header').innerText = `${year}年 ${month+1}月`;
            const first = new Date(year, month, 1).getDay();
            const last = new Date(year, month+1, 0).getDate();
            for(let i=0; i<first; i++) body.innerHTML += `<div class="calendar-day bg-slate-50/50"></div>`;
            for(let d=1; d<=last; d++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const tks = data.filter(t => t.date === dateKey);
                body.innerHTML += `<div class="calendar-day border-r border-b min-h-[80px]">
                    <span class="text-[10px] font-bold text-gray-400">${d}</span>
                    <div class="mt-1 space-y-1">${tks.map(t => `<div class="text-[8px] bg-indigo-50 text-indigo-700 p-0.5 rounded truncate font-bold">${t.title}</div>`).join('')}</div>
                </div>`;
            }
        }

        // --- UI基本機能 ---
        function updateStats() {
            const s = { all: tasks.length, todo: tasks.filter(t=>t.status==='todo').length, doing: tasks.filter(t=>t.status==='doing').length, done: tasks.filter(t=>t.status==='done').length };
            document.getElementById('stats-container').innerHTML = `
                <div class="bg-white p-5 rounded-2xl border flex items-center gap-4"><div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-list"></i></div><div><div class="text-xl font-bold">${s.all}</div><div class="text-[10px] text-gray-400 font-bold">合計</div></div></div>
                <div class="bg-white p-5 rounded-2xl border flex items-center gap-4"><div class="w-10 h-10 bg-amber-100 text-amber-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-circle-exclamation"></i></div><div><div class="text-xl font-bold">${s.todo}</div><div class="text-[10px] text-gray-400 font-bold">未着手</div></div></div>
                <div class="bg-white p-5 rounded-2xl border flex items-center gap-4"><div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-spinner"></i></div><div><div class="text-xl font-bold">${s.doing}</div><div class="text-[10px] text-gray-400 font-bold">進行中</div></div></div>
                <div class="bg-white p-5 rounded-2xl border flex items-center gap-4"><div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-check-double"></i></div><div><div class="text-xl font-bold">${s.done}</div><div class="text-[10px] text-gray-400 font-bold">完了</div></div></div>`;
        }
        function openTaskModal() { document.getElementById('task-form').reset(); document.getElementById('edit-id').value = ''; document.getElementById('task-modal-title').innerText = "新規タスク"; toggleDateInput(true); document.getElementById('modal-task').classList.remove('hidden'); }
        function editTask(id) {
            const t = tasks.find(x => x.id === id);
            document.getElementById('edit-id').value = t.id;
            document.getElementById('task-title').value = t.title;
            document.getElementById('task-priority').value = t.priority;
            document.getElementById('task-category-select').value = t.category;
            document.getElementById('task-date-picker').value = t.date || '';
            syncPickerToSmart(t.date);
            document.getElementById('task-date-enabled').checked = !!t.date;
            toggleDateInput(!!t.date);
            document.getElementById('task-modal-title').innerText = "タスク編集";
            document.getElementById('modal-task').classList.remove('hidden');
        }
        function saveTask(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const dateEnabled = document.getElementById('task-date-enabled').checked;
            const tData = {
                id: id ? parseFloat(id) : Date.now(),
                title: document.getElementById('task-title').value,
                priority: document.getElementById('task-priority').value,
                category: document.getElementById('task-category-select').value,
                date: dateEnabled ? document.getElementById('task-date-picker').value : '',
                desc: document.getElementById('task-desc').value,
                status: id ? tasks.find(x=>x.id==id).status : 'todo'
            };
            if(id) { const idx = tasks.findIndex(x=>x.id==id); tasks[idx] = tData; }
            else { tasks.push(tData); }
            applyFilters(); closeModal('modal-task');
        }
        function processBulkInput() {
            const lines = document.getElementById('bulk-typing-area').value.split('\n');
            const year = new Date().getFullYear();
            lines.forEach(l => {
                const [title, desc, prio, cat, mmdd] = l.split(',').map(s => s?.trim());
                if(title) {
                    let d = '';
                    if(mmdd && mmdd.length === 4 && mmdd !== 'なし') d = `${year}-${mmdd.substring(0,2)}-${mmdd.substring(2,4)}`;
                    tasks.push({ id: Date.now()+Math.random(), title, desc: desc||'', priority: prio||'中', category: cat||'個人', date: d, status: 'todo' });
                }
            });
            applyFilters(); closeModal('modal-bulk');
        }
        function saveUserData() { if(currentUser && currentUser !== 'Admin') localStorage.setItem(`tf_data_${currentUser}`, JSON.stringify({tasks, categories})); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function toggleMenu(e, id) { e.stopPropagation(); closeAllMenus(); document.getElementById(`menu-${id}`).classList.toggle('show'); }
        function closeAllMenus() { document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show')); }
        function toggleUserDropdown(e) { e.stopPropagation(); document.getElementById('user-dropdown').classList.toggle('show'); }
        function updateCategoryUI() {
            const list = document.getElementById('cat-list-container'); list.innerHTML = categories.map((c, i) => `<div class="flex justify-between p-2 bg-slate-50 border rounded-lg text-sm font-bold">${c}<button onclick="removeCategory(${i})" class="text-red-400">×</button></div>`).join('');
            document.getElementById('task-category-select').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('filter-category').innerHTML = '<option value="all">全カテゴリ</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        function addCategory() { const v = document.getElementById('new-cat-input').value.trim(); if(v && !categories.includes(v)) { categories.push(v); updateCategoryUI(); } }
        function removeCategory(i) { categories.splice(i,1); updateCategoryUI(); }
        function toggleConfigModal() { document.getElementById('modal-config').classList.toggle('hidden'); }
        function toggleImportModal() { document.getElementById('modal-import').classList.toggle('hidden'); }
        function toggleBulkInputModal() { document.getElementById('modal-bulk').classList.toggle('hidden'); }
        function quickStatus(id, s) { const t = tasks.find(x=>x.id===id); t.status = s; applyFilters(); }
        function duplicateTask(id) { const t = tasks.find(x=>x.id===id); tasks.push({...t, id: Date.now()+Math.random(), title: t.title+' (コピー)'}); applyFilters(); }
        function deleteTask(id) { if(confirm('削除しますか？')) { tasks = tasks.filter(x=>x.id!==id); applyFilters(); } }

        window.onload = () => {
            const sess = localStorage.getItem('tf_active_session');
            document.getElementById('filter-status').innerHTML = '<option value="all">全ステータス</option><option value="todo">未着手</option><option value="doing">進行中</option><option value="done">完了</option>';
            if(sess) login(sess);
        };
    </script>
</body>
</html>