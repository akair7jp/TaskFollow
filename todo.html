<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¿ã‚¹ã‚¯ç®¡ç† - TaskFollow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --p: #5b50f2; --bg: #f8f9fc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: #333; }
        .rounded-2xl { border-radius: 1.25rem; }
        header { background: white; padding: 15px 40px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ */
        .u-area { position: relative; cursor: pointer; font-weight: 600; }
        .dropdown { display: none; position: absolute; top: 100%; left: 0; background: white; box-shadow: 0 8px 30px rgba(0,0,0,0.1); border-radius: 1rem; z-index: 1000; min-width: 220px; overflow: hidden; }
        .u-area:hover .dropdown { display: block; }
        .dropdown button { width: 100%; border: none; background: none; text-align: left; padding: 12px 20px; cursor: pointer; font-size: 13px; font-family: inherit; border-bottom: 1px solid #f9f9f9; }
        .dropdown button:hover { background: #f8f9fc; }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ (æ—¥æœ¬èª) */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px 40px; }
        .stat-card { background: white; padding: 20px; border-radius: 1.25rem; border: 1px solid #eee; display: flex; align-items: center; gap: 15px; }

        /* ä¸€æ‹¬æ“ä½œãƒãƒ¼ (é¸æŠæ™‚ã®ã¿) */
        .bulk-bar { display: none; background: var(--p); color: white; margin: 0 40px 20px; padding: 15px 25px; border-radius: 1rem; justify-content: space-between; align-items: center; }
        .bulk-btns button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 15px; border-radius: 0.5rem; cursor: pointer; font-family: inherit; font-weight: 600; font-size: 13px; }

        /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ */
        .task-card { background: white; padding: 25px; border-radius: 1.5rem; border: 1px solid #eee; margin: 0 40px 15px; }
        .st-btn { padding: 10px 24px; border-radius: 2rem; border: 1px solid #eee; background: white; cursor: pointer; color: #999; font-size: 13px; font-weight: 600; margin-right: 10px; font-family: inherit; }
        .st-btn.active { background: var(--p); color: white; border-color: var(--p); }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ */
        #task-list.grid-view { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; padding: 20px 40px; }
        .grid-view .task-card { margin: 0; padding: 15px; }

        /* ä¸€æ‹¬ç™»éŒ²ã‚¨ãƒªã‚¢ */
        #bulk-typing-area { width: 100%; height: 200px; padding: 15px; border: 1px solid #eee; border-radius: 1rem; background: #fafafa; font-family: monospace; font-size: 14px; box-sizing: border-box; }

        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 35px; border-radius: 1.5rem; z-index: 2000; box-shadow: 0 20px 80px rgba(0,0,0,0.2); width: 480px; }
        .hidden { display: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1999; }
    </style>
</head>
<body>
    <header>
        <div>
            <h2 style="margin:0;">ã‚¿ã‚¹ã‚¯ç®¡ç†</h2>
            <div class="u-area"><span id="u-name">...</span> ã•ã‚“ <i class="fa-solid fa-chevron-down" style="font-size:10px;"></i>
                <div class="dropdown">
                    <button onclick="alert('ãƒ¡ã‚¢ãƒ‰å¤‰æ›´')"><i class="fa-solid fa-envelope"></i> ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´</button>
                    <button onclick="alert('é›»è©±ç•ªå·å¤‰æ›´')"><i class="fa-solid fa-phone"></i> é›»è©±ç•ªå·å¤‰æ›´</button>
                    <button onclick="alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´')"><i class="fa-solid fa-key"></i> ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
                    <button onclick="alert('ãƒ¦ãƒ¼ã‚¶åå¤‰æ›´')"><i class="fa-solid fa-user-edit"></i> ãƒ¦ãƒ¼ã‚¶åå¤‰æ›´</button>
                    <button id="logout-btn" style="color:#ff4d4d;"><i class="fa-solid fa-right-from-bracket"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="openM('import')"><i class="fa-solid fa-file-import"></i> ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <button onclick="openM('bulk')"><i class="fa-solid fa-list-check"></i> ä¸€æ‹¬ç™»éŒ²</button>
            <button onclick="openM('new')" style="background:var(--p); color:white; border:none; padding:12px 24px; border-radius:10px; font-weight:700;">+ æ–°è¦ã‚¿ã‚¹ã‚¯</button>
        </div>
    </header>

    <div class="stats">
        <div class="stat-card"><div style="background:#f0efff; color:var(--p); width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:10px;"><i class="fa-solid fa-list"></i></div><div><b id="c-all">0</b><br><small>åˆè¨ˆ</small></div></div>
        <div class="stat-card"><div style="background:#fff7ed; color:#f97316; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:10px;"><i class="fa-solid fa-circle-exclamation"></i></div><div><b id="c-un">0</b><br><small>æœªç€æ‰‹</small></div></div>
        <div class="stat-card"><div style="background:#f0f9ff; color:#0ea5e9; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:10px;"><i class="fa-solid fa-spinner"></i></div><div><b id="c-ing">0</b><br><small>é€²è¡Œä¸­</small></div></div>
        <div class="stat-card"><div style="background:#f0fdf4; color:#22c55e; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:10px;"><i class="fa-solid fa-circle-check"></i></div><div><b id="c-fin">0</b><br><small>å®Œäº†</small></div></div>
    </div>

    <div class="bulk-bar" id="bulk-ui">
        <div><button onclick="selectAll()" style="background:none; border:1px solid white; color:white; padding:5px 12px; border-radius:5px; cursor:pointer;">ã™ã¹ã¦é¸æŠ</button> <span id="sel-txt" style="margin-left:15px; font-weight:700;">0 ä»¶é¸æŠä¸­</span></div>
        <div class="bulk-btns" style="display:flex; gap:10px;">
            <select id="bulk-st-sel" style="background:none; border:1px solid white; color:white; border-radius:5px; padding:5px;"><option>çŠ¶æ…‹å¤‰æ›´</option><option>æœªç€æ‰‹</option><option>é€²è¡Œä¸­</option><option>å®Œäº†</option></select>
            <button onclick="bulkCopy()">ä¸€æ‹¬è¤‡è£½</button>
            <button onclick="bulkDel()" style="background:#ff4d4d; border:none;">ä¸€æ‹¬å‰Šé™¤</button>
        </div>
    </div>

    <div style="padding:0 40px 15px; display:flex; gap:12px; align-items:center;">
        <select id="f-st"><option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option><option>æœªç€æ‰‹</option><option>é€²è¡Œä¸­</option><option>å®Œäº†</option></select>
        <select id="f-pri"><option value="">å…¨å„ªå…ˆåº¦</option><option>é«˜</option><option>ä¸­</option><option>ä½</option></select>
        <select id="f-cat"><option value="">å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼</option></select>
        <select id="f-sort"><option value="pri">å„ªå…ˆåº¦é †</option><option value="date">æœŸé™é †</option></select>
        <div style="margin-left:auto; background:#eee; padding:3px; border-radius:8px;">
            <button id="v-list" onclick="setView('list')" style="border:none; padding:8px 15px; border-radius:6px; background:white; cursor:pointer;">ãƒªã‚¹ãƒˆ</button>
            <button id="v-cal" onclick="setView('cal')" style="border:none; padding:8px 15px; border-radius:6px; background:none; cursor:pointer; color:#888;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
        </div>
    </div>

    <div id="task-list"></div>

    <div id="overlay" class="overlay hidden" onclick="closeAll()"></div>
    
    <!-- æ–°è¦ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="new-modal" class="modal hidden">
        <h3 style="margin-top:0;">æ–°è¦ã‚¿ã‚¹ã‚¯</h3>
        <input type="text" id="t-title" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›..." style="width:100%; padding:14px; border:1px solid #eee; border-radius:10px; margin-bottom:15px; box-sizing:border-box;">
        <div style="display:flex; gap:15px; margin-bottom:15px;">
            <select id="t-pri-val" style="flex:1; padding:12px; border-radius:10px; border:1px solid #eee;"><option>é«˜</option><option selected>ä¸­</option><option>ä½</option></select>
            <input type="text" id="t-cat-val" placeholder="ã‚«ãƒ†ã‚´ãƒªãƒ¼" style="flex:1; padding:12px; border-radius:10px; border:1px solid #eee;">
        </div>
        <div style="background:#f9f9fc; padding:20px; border-radius:15px; border:1px solid #eee;">
            <label style="font-weight:700;"><input type="checkbox" id="t-limit-on" checked> æœŸé™ã‚’è¨­ã‘ã‚‹</label>
            <div style="margin-top:15px;">
                <small style="color:#888;">ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ› (MMDD)</small>
                <input type="text" id="t-mmdd" placeholder="0520" style="width:100%; padding:10px; margin:5px 0 10px; border:1px solid #eee; border-radius:8px;">
                <small style="color:#888;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠ</small>
                <input type="date" id="t-date" style="width:100%; padding:10px; border:1px solid #eee; border-radius:8px;">
            </div>
        </div>
        <div style="display:flex; gap:15px; margin-top:25px;">
            <button onclick="closeAll()" style="flex:1; padding:14px; border:none; background:#eee; border-radius:10px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="saveTask()" style="flex:1; padding:14px; border:none; background:var(--p); color:white; font-weight:700; border-radius:10px; cursor:pointer;">ä¿å­˜</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, deleteDoc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyBV5WcWYSBUybd-Jv6iUnC80QNFAjMc5VU", authDomain: "taskfollow-b70ff.firebaseapp.com", projectId: "taskfollow-b70ff" }));
        const auth = getAuth();
        let userNow = null;

        onAuthStateChanged(auth, async (u) => {
            if (!u) window.location.href = "index.html";
            userNow = u;
            const uDoc = await getDoc(doc(db, "users", u.uid));
            document.getElementById('u-name').innerText = uDoc.data()?.displayName || u.email.split('@');
            initApp();
        });

        window.openM = (type) => { 
            document.getElementById('overlay').classList.remove('hidden');
            if(type==='new') document.getElementById('new-modal').classList.remove('hidden');
        };
        window.closeAll = () => document.querySelectorAll('.modal, .overlay').forEach(el => el.classList.add('hidden'));

        window.saveTask = async () => {
            const hasL = document.getElementById('t-limit-on').checked;
            const date = hasL ? (document.getElementById('t-date').value || "æœŸé™ãªã—") : "æœŸé™ãªã—";
            await addDoc(collection(db, "tasks"), { uid: userNow.uid, title: document.getElementById('t-title').value, priority: document.getElementById('t-pri-val').value, category: document.getElementById('t-cat-val').value || "ãªã—", date, status: "æœªç€æ‰‹", createdAt: new Date() });
            closeAll();
        };

        function initApp() {
            const q = query(collection(db, "tasks"), where("uid", "==", userNow.uid), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('task-list');
                list.innerHTML = "";
                let counts = { all: snap.size, un: 0, ing: 0, fin: 0 };
                snap.forEach(d => {
                    const t = d.data();
                    if(t.status === "æœªç€æ‰‹") counts.un++; else if(t.status === "é€²è¡Œä¸­") counts.ing++; else counts.fin++;
                    list.innerHTML += `
                        <div class="task-card">
                            <div style="font-size:20px; font-weight:700;"><input type="checkbox" class="t-sel" data-id="${d.id}" onchange="upBulk()"> ${t.title}</div>
                            <div style="margin: 12px 0 20px 30px; font-size:12px; color:#888; display:flex; gap:15px; align-items:center;">
                                <span><i class="fa-solid fa-flag" style="color:#ff4d4d; margin-right:5px;"></i>${t.priority}</span>
                                <span style="background:#f0efff; color:var(--p); padding:2px 10px; border-radius:6px; font-weight:700;">${t.category}</span>
                                <span>ğŸ•’ ${t.date}</span>
                            </div>
                            <div style="margin-left:30px;">
                                <button class="st-btn ${t.status=='æœªç€æ‰‹'?'active':''}" onclick="upSt('${d.id}','æœªç€æ‰‹')">æœªç€æ‰‹</button>
                                <button class="st-btn ${t.status=='é€²è¡Œä¸­'?'active':''}" onclick="upSt('${d.id}','é€²è¡Œä¸­')">é€²è¡Œä¸­</button>
                                <button class="st-btn ${t.status=='å®Œäº†'?'active':''}" onclick="upSt('${d.id}','å®Œäº†')">å®Œäº†</button>
                                <button onclick="delT('${d.id}')" style="float:right; border:none; background:none; color:red; cursor:pointer;">å‰Šé™¤</button>
                                <button onclick="copyT('${d.id}')" style="float:right; border:none; background:none; color:#888; cursor:pointer; margin-right:15px;">è¤‡è£½</button>
                            </div>
                        </div>`;
                });
                document.getElementById('c-all').innerText = counts.all;
                document.getElementById('c-un').innerText = counts.un;
                document.getElementById('c-ing').innerText = counts.ing;
                document.getElementById('c-fin').innerText = counts.fin;
            });
        }

        window.upSt = async (id, st) => await updateDoc(doc(db, "tasks", id), { status: st });
        window.upBulk = () => {
            const n = document.querySelectorAll('.t-sel:checked').length;
            document.getElementById('bulk-ui').style.display = n > 0 ? 'flex' : 'none';
            document.getElementById('sel-txt').innerText = `${n} ä»¶é¸æŠä¸­`;
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => window.location.href="index.html");
    </script>
</body>
</html>
