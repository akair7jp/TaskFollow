<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¿ã‚¹ã‚¯ç®¡ç† - TaskFollow</title>
    <style>
        :root { --primary: #5b50f2; --bg: #f8f9fc; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; color: #333; }
        header { background: white; padding: 15px 40px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        /* CSSã§å†ç¾ã—ãŸã‚¢ã‚¤ã‚³ãƒ³ç¾¤ */
        .icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .ic-total { background: #eef2ff; color: #5b50f2; }
        .ic-un { background: #fff7ed; color: #f97316; }
        .ic-ing { background: #f0f9ff; color: #0ea5e9; }
        .ic-fin { background: #f0fdf4; color: #22c55e; }
        
        /* æ——ã‚¢ã‚¤ã‚³ãƒ³ (SVG) */
        .flag-red { width: 14px; height: 14px; fill: #ff4d4d; vertical-align: middle; margin-right: 4px; }

        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px 40px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .stat-card b { font-size: 24px; display: block; line-height: 1; }
        .stat-card small { color: #888; font-size: 12px; }

        .bulk-bar { background: var(--primary); color: white; margin: 0 40px 20px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        .task-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid #eee; margin: 0 40px 15px; transition: 0.2s; }
        .st-btn { padding: 6px 15px; border-radius: 20px; border: 1px solid #eee; background: white; cursor: pointer; font-size: 12px; color: #999; margin-right: 5px; }
        .st-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; width: 450px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 1000; }
        .hidden { display: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; }
    </style>
</head>
<body>
    <header>
        <div><h2 style="margin:0;">ã‚¿ã‚¹ã‚¯ç®¡ç†</h2><span id="u-display" style="font-size:14px; color:#888;">...</span> ã•ã‚“</div>
        <div style="display:flex; gap:10px;">
            <button onclick="toggleModal(true)" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;">+ æ–°è¦ã‚¿ã‚¹ã‚¯</button>
            <button id="logout-btn" style="border:none; background:none; color:#888; cursor:pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </header>

    <div class="stats">
        <div class="stat-card">
            <div class="icon ic-total"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h10M8 12h10M8 18h10M4 6h.01M4 12h.01M4 18h.01"/></svg></div>
            <div><b id="c-total">0</b><small>åˆè¨ˆ</small></div>
        </div>
        <div class="stat-card">
            <div class="icon ic-un"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>
            <div><b id="c-un">0</b><small>æœªç€æ‰‹</small></div>
        </div>
        <div class="stat-card">
            <div class="icon ic-ing"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></div>
            <div><b id="c-ing">0</b><small>é€²è¡Œä¸­</small></div>
        </div>
        <div class="stat-card">
            <div class="icon ic-fin"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div>
            <div><b id="c-fin">0</b><small>å®Œäº†</small></div>
        </div>
    </div>

    <div class="bulk-bar" id="bulk-ui" style="display:none;">
        <div id="sel-info">0 ä»¶é¸æŠä¸­</div>
        <button id="bulk-del-btn" style="background:#ff4d4d; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">ä¸€æ‹¬å‰Šé™¤</button>
    </div>

    <div id="task-container" class="task-list"></div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="overlay" class="overlay hidden" onclick="toggleModal(false)"></div>
    <div id="modal" class="modal hidden">
        <h3 style="margin-top:0;">ã‚¿ã‚¹ã‚¯ä½œæˆ</h3>
        <input type="text" id="t-input" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›..." style="width:100%; padding:12px; border:1px solid #eee; border-radius:8px; box-sizing:border-box; margin-bottom:15px;">
        <select id="t-priority" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #eee;">
            <option value="é«˜">å„ªå…ˆåº¦: é«˜</option><option value="ä¸­" selected>å„ªå…ˆåº¦: ä¸­</option><option value="ä½">å„ªå…ˆåº¦: ä½</option>
        </select>
        <div style="display:flex; gap:10px;">
            <button onclick="toggleModal(false)" style="flex:1; padding:12px; border:none; border-radius:8px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="addTask()" style="flex:1; padding:12px; border:none; border-radius:8px; background:var(--primary); color:white; cursor:pointer; font-weight:bold;">ä¿å­˜</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const app = initializeApp({ apiKey: "AIzaSyBV5WcWYSBUybd-Jv6iUnC80QNFAjMc5VU", authDomain: "taskfollow-b70ff.firebaseapp.com", projectId: "taskfollow-b70ff" });
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userNow = null;

        onAuthStateChanged(auth, (u) => {
            if (!u) window.location.href = "index.html";
            userNow = u;
            document.getElementById('u-display').innerText = u.email.split('@');
            initApp();
        });

        window.toggleModal = (s) => {
            document.getElementById('modal').classList.toggle('hidden', !s);
            document.getElementById('overlay').classList.toggle('hidden', !s);
        };

        window.addTask = async () => {
            const val = document.getElementById('t-input').value;
            if (!val) return;
            await addDoc(collection(db, "tasks"), {
                uid: userNow.uid, title: val, priority: document.getElementById('t-priority').value,
                status: "æœªç€æ‰‹", createdAt: new Date()
            });
            toggleModal(false);
            document.getElementById('t-input').value = "";
        };

        function initApp() {
            const q = query(collection(db, "tasks"), where("uid", "==", userNow.uid), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const cont = document.getElementById('task-container');
                cont.innerHTML = "";
                let s = { total: snap.size, un: 0, ing: 0, fin: 0 };
                
                snap.forEach(d => {
                    const t = d.data();
                    if (t.status === "æœªç€æ‰‹") s.un++;
                    else if (t.status === "é€²è¡Œä¸­") s.ing++;
                    else s.fin++;

                    cont.innerHTML += `
                        <div class="task-card">
                            <div style="font-weight:bold; font-size:18px; margin-bottom:10px;">
                                <input type="checkbox"> ${t.title}
                            </div>
                            <div style="font-size:12px; color:#888; margin-left:25px; margin-bottom:15px;">
                                <svg class="flag-red" viewBox="0 0 24 24"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
                                ${t.priority} <span style="margin-left:15px;">ğŸ•’ æœŸé™ãªã—</span>
                            </div>
                            <div style="margin-left:25px;">
                                <button class="st-btn ${t.status=='æœªç€æ‰‹'?'active':''}" onclick="upSt('${d.id}','æœªç€æ‰‹')">æœªç€æ‰‹</button>
                                <button class="st-btn ${t.status=='é€²è¡Œä¸­'?'active':''}" onclick="upSt('${d.id}','é€²è¡Œä¸­')">é€²è¡Œä¸­</button>
                                <button class="st-btn ${t.status=='å®Œäº†'?'active':''}" onclick="upSt('${d.id}','å®Œäº†')">å®Œäº†</button>
                                <button onclick="delT('${d.id}')" style="float:right; border:none; background:none; color:red; cursor:pointer;">å‰Šé™¤</button>
                            </div>
                        </div>`;
                });
                document.getElementById('c-total').innerText = s.total;
                document.getElementById('c-un').innerText = s.un;
                document.getElementById('c-ing').innerText = s.ing;
                document.getElementById('c-fin').innerText = s.fin;
            });
        }

        window.upSt = async (id, st) => await updateDoc(doc(db, "tasks", id), { status: st });
        window.delT = async (id) => { if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) await deleteDoc(doc(db, "tasks", id)); };
        document.getElementById('logout-btn').onclick = () => signOut(auth);
    </script>
</body>
</html>
