<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¿ã‚¹ã‚¯ç®¡ç† - TaskFollow</title>
    <style>
        :root { --p: #5b50f2; --bg: #f8f9fc; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; }
        header { background: white; padding: 15px 40px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ */
        .user-menu { position: relative; cursor: pointer; font-weight: bold; }
        .dropdown { display: none; position: absolute; top: 100%; left: 0; background: white; box-shadow: 0 8px 24px rgba(0,0,0,0.1); border-radius: 12px; z-index: 100; min-width: 180px; padding: 10px 0; }
        .user-menu:hover .dropdown { display: block; }
        .dropdown button { width: 100%; border: none; background: none; text-align: left; padding: 12px 20px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f5f5f5; }
        .dropdown button:last-child { color: #ff4d4d; border: none; }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ (æ—¥æœ¬èªè¡¨è¨˜ & éOSã‚¢ã‚¤ã‚³ãƒ³) */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px 40px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .icon-box { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: #f0efff; color: var(--p); }

        /* ä¸€æ‹¬æ“ä½œãƒãƒ¼ */
        .bulk-bar { background: var(--p); color: white; margin: 0 40px 20px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .bulk-btns button { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-left: 10px; }

        /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ */
        .task-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid #eee; margin: 0 40px 15px; position: relative; }
        .flag { display: inline-block; width: 12px; height: 12px; background: #ff4d4d; clip-path: polygon(0 0, 100% 25%, 0 50%, 0 100%, 15% 100%, 15% 50%, 0 50%); margin-right: 5px; }
        .st-btn { padding: 8px 18px; border-radius: 20px; border: 1px solid #eee; background: white; font-size: 12px; cursor: pointer; color: #999; margin-right: 10px; }
        .st-btn.active { background: var(--p); color: white; border-color: var(--p); }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; width: 450px; z-index: 1000; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .hidden { display: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; }
    </style>
</head>
<body>
    <header>
        <div>
            <h2 style="margin:0;">ã‚¿ã‚¹ã‚¯ç®¡ç†</h2>
            <div class="user-menu"><span id="u-name">...</span> ã•ã‚“ âˆ¨
                <div class="dropdown">
                    <button onclick="alert('ãƒ¡ã‚¢ãƒ‰å¤‰æ›´ç”»é¢ã¸')">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´</button>
                    <button onclick="alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢ã¸')">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
                    <button onclick="alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´ç”»é¢ã¸')">ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´</button>
                    <button id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="showImport()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <button onclick="showBulk()">ä¸€æ‹¬ç™»éŒ²</button>
            <button onclick="toggleModal(true)" style="background:var(--p); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">+ æ–°è¦ã‚¿ã‚¹ã‚¯</button>
        </div>
    </header>

    <div class="stats">
        <div class="stat-card"><div class="icon-box">Î£</div><div><b id="c-all">0</b><br><small>åˆè¨ˆ</small></div></div>
        <div class="stat-card"><div class="icon-box">!</div><div><b id="c-un">0</b><br><small>æœªç€æ‰‹</small></div></div>
        <div class="stat-card"><div class="icon-box">~</div><div><b id="c-ing">0</b><br><small>é€²è¡Œä¸­</small></div></div>
        <div class="stat-card"><div class="icon-box">v</div><div><b id="c-fin">0</b><br><small>å®Œäº†</small></div></div>
    </div>

    <div class="bulk-bar">
        <div><button onclick="selectAll()">ã™ã¹ã¦é¸æŠ</button> <span id="sel-info">0 ä»¶é¸æŠä¸­</span></div>
        <div class="bulk-btns">
            <button onclick="bulkStatus()">çŠ¶æ…‹å¤‰æ›´</button>
            <button onclick="bulkCopy()">ä¸€æ‹¬è¤‡è£½</button>
            <button onclick="bulkDel()" style="background:#ff4d4d;">ä¸€æ‹¬å‰Šé™¤</button>
        </div>
    </div>

    <div style="padding: 0 40px 10px; display:flex; gap:10px;">
        <select id="f-st"><option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option><option>æœªç€æ‰‹</option><option>é€²è¡Œä¸­</option><option>å®Œäº†</option></select>
        <select id="f-pri"><option value="">å…¨å„ªå…ˆåº¦</option><option>é«˜</option><option>ä¸­</option><option>ä½</option></select>
        <select id="f-cat"><option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option><option>ä»•äº‹</option><option>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ</option></select>
        <select id="f-sort"><option value="pri">å„ªå…ˆåº¦é †</option><option value="date">æœŸé™é †</option></select>
        <div style="margin-left:auto;">
            <button onclick="setView('list')">ãƒªã‚¹ãƒˆ</button>
            <button onclick="setView('cal')">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
        </div>
    </div>

    <div id="task-list"></div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: æ–°è¦ã‚¿ã‚¹ã‚¯ -->
    <div id="overlay" class="overlay hidden" onclick="toggleModal(false)"></div>
    <div id="modal" class="modal hidden">
        <h3>ã‚¿ã‚¹ã‚¯ä½œæˆ</h3>
        <input type="text" id="t-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" style="width:100%; padding:10px; margin-bottom:15px;">
        <select id="t-pri-val" style="width:100%; padding:10px; margin-bottom:15px;"><option>é«˜</option><option selected>ä¸­</option><option>ä½</option></select>
        <input type="text" id="t-cat-val" placeholder="ã‚«ãƒ†ã‚´ãƒªãƒ¼" style="width:100%; padding:10px; margin-bottom:15px;">
        
        <div style="border:1px solid #eee; padding:15px; border-radius:10px;">
            <label><input type="checkbox" id="t-limit-on" checked> æœŸé™ã‚’è¨­ã‘ã‚‹</label>
            <div style="margin-top:10px;">
                <small>ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ› (MMDD)</small>
                <input type="text" id="t-mmdd" placeholder="0520" style="width:100%; padding:8px; margin-bottom:10px;">
                <small>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠ</small>
                <input type="date" id="t-date" style="width:100%; padding:8px;">
            </div>
        </div>
        
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button onclick="toggleModal(false)" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="saveTask()" style="flex:1; background:var(--p); color:white; border:none; border-radius:8px;">ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜</button>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
    <div id="import-modal" class="modal hidden">
        <h3>ã‚¿ã‚¹ã‚¯ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
        <p style="font-size:12px; color:#666;">CSV ã¾ãŸã¯ JSONå½¢å¼ (ä¸Šé™10MB)</p>
        <input type="file" id="f-upload">
        <button onclick="document.getElementById('import-modal').classList.add('hidden')">é–‰ã˜ã‚‹</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const app = initializeApp({ apiKey: "AIzaSyBV5WcWYSBUybd-Jv6iUnC80QNFAjMc5VU", authDomain: "taskfollow-b70ff.firebaseapp.com", projectId: "taskfollow-b70ff" });
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userNow = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) window.location.href = "index.html";
            userNow = user;
            const uDoc = await getDoc(doc(db, "users", user.uid));
            document.getElementById('u-name').innerText = uDoc.data()?.displayName || user.email.split('@');
            renderTasks();
        });

        window.toggleModal = (s) => {
            document.getElementById('modal').classList.toggle('hidden', !s);
            document.getElementById('overlay').classList.toggle('hidden', !s);
        };

        window.saveTask = async () => {
            const limitOn = document.getElementById('t-limit-on').checked;
            let dateVal = limitOn ? (document.getElementById('t-date').value || "æœŸé™ãªã—") : "æœŸé™ãªã—";
            
            await addDoc(collection(db, "tasks"), {
                uid: userNow.uid,
                title: document.getElementById('t-title').value,
                priority: document.getElementById('t-pri-val').value,
                category: document.getElementById('t-cat-val').value || "ãªã—",
                date: dateVal,
                status: "æœªç€æ‰‹",
                createdAt: new Date()
            });
            toggleModal(false);
        };

        function renderTasks() {
            const q = query(collection(db, "tasks"), where("uid", "==", userNow.uid));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('task-list');
                list.innerHTML = "";
                let counts = { all: snap.size, un: 0, ing: 0, fin: 0 };
                
                snap.forEach(d => {
                    const t = d.data();
                    if(t.status === "æœªç€æ‰‹") counts.un++;
                    else if(t.status === "é€²è¡Œä¸­") counts.ing++;
                    else counts.fin++;

                    list.innerHTML += `
                        <div class="task-card">
                            <div style="font-size:18px; font-weight:bold;"><input type="checkbox" class="t-sel" data-id="${d.id}"> ${t.title}</div>
                            <div style="margin: 10px 0 15px 25px; font-size:12px; color:#888; display:flex; gap:15px;">
                                <span><span class="flag"></span>${t.priority}</span>
                                <span style="background:#f0efff; color:var(--p); padding:2px 8px; border-radius:4px;">${t.category}</span>
                                <span>ğŸ•’ ${t.date}</span>
                            </div>
                            <div style="margin-left:25px;">
                                <button class="st-btn ${t.status=='æœªç€æ‰‹'?'active':''}" onclick="upSt('${d.id}','æœªç€æ‰‹')">æœªç€æ‰‹</button>
                                <button class="st-btn ${t.status=='é€²è¡Œä¸­'?'active':''}" onclick="upSt('${d.id}','é€²è¡Œä¸­')">é€²è¡Œä¸­</button>
                                <button class="st-btn ${t.status=='å®Œäº†'?'active':''}" onclick="upSt('${d.id}','å®Œäº†')">å®Œäº†</button>
                                <button onclick="copyTask('${d.id}')" style="margin-left:15px; border:none; background:none; cursor:pointer;">è¤‡è£½</button>
                                <button onclick="delTask('${d.id}')" style="color:red; border:none; background:none; cursor:pointer;">å‰Šé™¤</button>
                            </div>
                        </div>`;
                });
                document.getElementById('c-all').innerText = counts.all;
                document.getElementById('c-un').innerText = counts.un;
                document.getElementById('c-ing').innerText = counts.ing;
                document.getElementById('c-fin').innerText = counts.fin;
            });
        }

        window.upSt = async (id, st) => await updateDoc(doc(db, "tasks", id), { status: st });
        window.delTask = async (id) => { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) await deleteDoc(doc(db, "tasks", id)); };
        document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => window.location.href="index.html");
        
        // ã‚¹ãƒãƒ¼ãƒˆæ—¥ä»˜è£œå®Œ
        document.getElementById('t-mmdd').oninput = (e) => {
            if(e.target.value.length === 4) {
                const m = e.target.value.substring(0,2);
                const d = e.target.value.substring(2,4);
                document.getElementById('t-date').value = `2025-${m}-${d}`;
            }
        };
    </script>
</body>
</html>
