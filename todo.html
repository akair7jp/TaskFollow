<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¿ã‚¹ã‚¯ç®¡ç† - TaskFollow</title>
    <style>
        :root { --p: #5b50f2; --bg: #f8f9fc; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; color: #333; }
        header { background: white; padding: 15px 40px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ [4] */
        .u-area { position: relative; cursor: pointer; font-size: 14px; font-weight: bold; }
        .dropdown { display: none; position: absolute; top: 100%; left: 0; background: white; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-radius: 12px; z-index: 100; min-width: 200px; padding: 10px 0; }
        .u-area:hover .dropdown { display: block; }
        .dropdown button { width: 100%; border: none; background: none; text-align: left; padding: 12px 20px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f9f9f9; }
        .dropdown button:last-child { color: #ff4d4d; border: none; }

        /* çµ±è¨ˆ [3] */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px 40px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; border: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .ic-box { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }

        /* ä¸€æ‹¬ãƒãƒ¼ [3] */
        .bulk-bar { background: var(--p); color: white; margin: 0 40px 20px; padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .bulk-actions button, .bulk-actions select { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-left: 10px; font-size: 13px; }

        /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ [6] */
        .task-card { background: white; padding: 25px; border-radius: 20px; border: 1px solid #eee; margin: 0 40px 15px; }
        .flag { display: inline-block; width: 14px; height: 14px; background: #ff4d4d; clip-path: polygon(0 0, 100% 25%, 0 50%, 0 100%, 15% 100%, 15% 50%, 0 50%); margin-right: 6px; }
        .st-btn { padding: 8px 20px; border-radius: 25px; border: 1px solid #eee; background: white; font-size: 12px; cursor: pointer; color: #999; margin-right: 10px; }
        .st-btn.active { background: var(--p); color: white; border-color: var(--p); }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« [1, 10] */
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 35px; border-radius: 24px; width: 480px; z-index: 1000; box-shadow: 0 20px 80px rgba(0,0,0,0.2); }
        .hidden { display: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; }
    </style>
</head>
<body>
    <header>
        <div>
            <h2 style="margin:0;">ã‚¿ã‚¹ã‚¯ç®¡ç† [7]</h2>
            <p style="font-size:11px; color:#999; margin:3px 0 10px;">ã‚ãªãŸã®ã‚¿ã‚¹ã‚¯ã‚’æ•´ç†ã—ã¦ã€åŠ¹ç‡çš„ã«ç®¡ç†ã—ã¾ã—ã‚‡ã† [7]</p>
            <div class="u-area"><span id="u-name">...</span> ã•ã‚“ âˆ¨ [3]
                <div class="dropdown">
                    <button onclick="alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´')">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´ [7]</button>
                    <button onclick="alert('é›»è©±ç•ªå·å¤‰æ›´')">é›»è©±ç•ªå·å¤‰æ›´ [7]</button>
                    <button onclick="alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´')">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ [7]</button>
                    <button id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ [7]</button>
                </div>
            </div>
        </div>
        <div style="display:flex; gap:12px;">
            <button onclick="showImport()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ [7]</button>
            <button onclick="showBulk()">ä¸€æ‹¬ç™»éŒ² [7]</button>
            <button onclick="toggleModal(true)" style="background:var(--p); color:white; border:none; padding:12px 24px; border-radius:10px; cursor:pointer;">+ æ–°è¦ã‚¿ã‚¹ã‚¯ [7]</button>
        </div>
    </header>

    <div class="stats">
        <div class="stat-card"><div class="ic-box" style="background:#f0efff; color:var(--p);">Î£</div><div><b id="c-all">0</b><br><small>åˆè¨ˆ [3]</small></div></div>
        <div class="stat-card"><div class="ic-box" style="background:#fff7ed; color:#f97316;">!</div><div><b id="c-un">0</b><br><small>æœªç€æ‰‹ [3]</small></div></div>
        <div class="stat-card"><div class="ic-box" style="background:#f0f9ff; color:#0ea5e9;">~</div><div><b id="c-ing">0</b><br><small>é€²è¡Œä¸­ [3]</small></div></div>
        <div class="stat-card"><div class="ic-box" style="background:#f0fdf4; color:#22c55e;">v</div><div><b id="c-fin">0</b><br><small>å®Œäº† [3]</small></div></div>
    </div>

    <div class="bulk-bar">
        <div><button onclick="selectAll()" style="background:none; border:1px solid white; color:white; padding:6px 12px; border-radius:6px; cursor:pointer;">ã™ã¹ã¦é¸æŠ [7]</button> <span id="sel-txt" style="margin-left:15px;">0 ä»¶é¸æŠä¸­ [3]</span></div>
        <div class="bulk-actions">
            <select id="bulk-st"><option>çŠ¶æ…‹å¤‰æ›´ [7]</option><option>æœªç€æ‰‹</option><option>é€²è¡Œä¸­</option><option>å®Œäº†</option></select>
            <button onclick="bulkCopy()">ä¸€æ‹¬è¤‡è£½ [7]</button>
            <button onclick="bulkDel()" style="background:#ff4d4d; border:none;">ä¸€æ‹¬å‰Šé™¤ [7]</button>
        </div>
    </div>

    <div style="padding: 0 40px 15px; display:flex; gap:12px; align-items:center;">
        <select id="f-st"><option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ [3]</option><option>æœªç€æ‰‹</option><option>é€²è¡Œä¸­</option><option>å®Œäº†</option></select>
        <select id="f-pri"><option value="">å…¨å„ªå…ˆåº¦ [3]</option><option>é«˜</option><option>ä¸­</option><option>ä½</option></select>
        <select id="f-cat"><option value="">å…¨ã‚«ãƒ†ã‚´ãƒª [3]</option></select>
        <select id="f-sort"><option value="pri">å„ªå…ˆåº¦é † [3]</option><option value="date">æœŸé™é † [3]</option></select>
        <div style="margin-left:auto; background:#eee; padding:3px; border-radius:8px;">
            <button id="v-list" onclick="setView('list')" style="border:none; padding:6px 15px; border-radius:6px; cursor:pointer; background:white;">ãƒªã‚¹ãƒˆ [3]</button>
            <button id="v-cal" onclick="setView('cal')" style="border:none; padding:6px 15px; border-radius:6px; cursor:pointer; background:none; color:#888;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ [3]</button>
        </div>
    </div>

    <div id="task-list"></div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: æ–°è¦ã‚¿ã‚¹ã‚¯ [1, 10] -->
    <div id="overlay" class="overlay hidden" onclick="toggleModal(false)"></div>
    <div id="modal" class="modal hidden">
        <h3 style="margin:0 0 25px;">æ–°è¦ã‚¿ã‚¹ã‚¯</h3>
        <input type="text" id="t-title" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›... [1]" style="width:100%; padding:14px; border:1px solid #eee; border-radius:10px; box-sizing:border-box; margin-bottom:15px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
            <select id="t-pri-val" style="padding:12px; border-radius:10px; border:1px solid #eee;"><option>å„ªå…ˆåº¦: é«˜</option><option selected>å„ªå…ˆåº¦: ä¸­</option><option>å„ªå…ˆåº¦: ä½</option></select>
            <input type="text" id="t-cat-val" placeholder="ã‚«ãƒ†ã‚´ãƒª [10]" style="padding:12px; border-radius:10px; border:1px solid #eee;">
        </div>
        <div style="background:#f9f9fc; padding:20px; border-radius:15px; border:1px solid #f0f0f5;">
            <label style="font-size:13px; font-weight:bold;"><input type="checkbox" id="t-limit-on" checked> æœŸé™ã‚’è¨­ã‘ã‚‹ [1, 8, 10]</label>
            <div style="margin-top:15px;">
                <small style="color:#888;">ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ› (MMDD) [1, 8]</small>
                <input type="text" id="t-mmdd" placeholder="ä¾‹: 0520 [1]" style="width:100%; padding:10px; margin:5px 0 15px; border:1px solid #eee; border-radius:8px;">
                <small style="color:#888;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠ [1, 8]</small>
                <input type="date" id="t-date" style="width:100%; padding:10px; border:1px solid #eee; border-radius:8px;">
            </div>
        </div>
        <textarea id="t-memo" placeholder="è©³ç´°ãƒ¡ãƒ¢... [1, 10]" style="width:100%; height:80px; margin-top:15px; border:1px solid #eee; border-radius:10px; padding:12px; box-sizing:border-box;"></textarea>
        <div style="display:flex; gap:15px; margin-top:25px;">
            <button onclick="toggleModal(false)" style="flex:1; padding:14px; border-radius:10px; border:none; background:#eee;">ã‚­ãƒ£ãƒ³ã‚»ãƒ« [1]</button>
            <button onclick="saveTask()" style="flex:1; padding:14px; border-radius:10px; border:none; background:var(--p); color:white; font-weight:bold;">ä¿å­˜ [1]</button>
        </div>
    </div>

    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”»é¢ [10] -->
    <div id="import-modal" class="modal hidden">
        <h3>ã‚¿ã‚¹ã‚¯ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
        <p style="font-size:12px; color:#666; margin-bottom:20px;">CSV ã¾ãŸã¯ JSONå½¢å¼ ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚ [10]<br>â€»ä¸Šé™ã‚µã‚¤ã‚º: 10MB [10]</p>
        <input type="file" id="f-upload" style="margin-bottom:20px;">
        <button onclick="document.getElementById('import-modal').classList.add('hidden')" style="width:100%; padding:10px;">é–‰ã˜ã‚‹</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, deleteDoc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const config = { apiKey: "AIzaSyBV5WcWYSBUybd-Jv6iUnC80QNFAjMc5VU", authDomain: "taskfollow-b70ff.firebaseapp.com", projectId: "taskfollow-b70ff" };
        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userNow = null;

        onAuthStateChanged(auth, async (u) => {
            if (!u) window.location.href = "index.html";
            userNow = u;
            const uDoc = await getDoc(doc(db, "users", u.uid));
            document.getElementById('u-name').innerText = uDoc.data()?.displayName || u.email.split('@');
            initTasks();
        });

        window.toggleModal = (s) => {
            document.getElementById('modal').classList.toggle('hidden', !s);
            document.getElementById('overlay').classList.toggle('hidden', !s);
        };

        window.saveTask = async () => {
            const limit = document.getElementById('t-limit-on').checked;
            const dateStr = limit ? (document.getElementById('t-date').value || "æœŸé™ãªã—") : "æœŸé™ãªã—";
            await addDoc(collection(db, "tasks"), {
                uid: userNow.uid, title: document.getElementById('t-title').value,
                priority: document.getElementById('t-pri-val').value.replace('å„ªå…ˆåº¦: ',''),
                category: document.getElementById('t-cat-val').value || "ãªã—",
                date: dateStr, status: "æœªç€æ‰‹", createdAt: new Date()
            });
            toggleModal(false);
        };

        function initTasks() {
            const q = query(collection(db, "tasks"), where("uid", "==", userNow.uid), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('task-list');
                list.innerHTML = "";
                let s = { all: snap.size, un: 0, ing: 0, fin: 0 };
                snap.forEach(d => {
                    const t = d.data();
                    if(t.status === "æœªç€æ‰‹") s.un++; else if(t.status === "é€²è¡Œä¸­") s.ing++; else s.fin++;
                    list.innerHTML += `
                        <div class="task-card">
                            <div style="font-size:20px; font-weight:bold; display:flex; align-items:center; gap:12px;">
                                <input type="checkbox" class="t-sel" data-id="${d.id}"> ${t.title}
                            </div>
                            <div style="margin: 12px 0 20px 30px; font-size:12px; color:#888; display:flex; gap:20px;">
                                <span><span class="flag"></span>${t.priority}</span>
                                <span style="background:#f0efff; color:var(--p); padding:2px 10px; border-radius:6px; font-weight:bold;">${t.category}</span>
                                <span>ğŸ•’ ${t.date}</span>
                            </div>
                            <div style="margin-left:30px; display:flex; align-items:center;">
                                <button class="st-btn ${t.status=='æœªç€æ‰‹'?'active':''}" onclick="upSt('${d.id}','æœªç€æ‰‹')">æœªç€æ‰‹ [7]</button>
                                <button class="st-btn ${t.status=='é€²è¡Œä¸­'?'active':''}" onclick="upSt('${d.id}','é€²è¡Œä¸­')">é€²è¡Œä¸­ [7]</button>
                                <button class="st-btn ${t.status=='å®Œäº†'?'active':''}" onclick="upSt('${d.id}','å®Œäº†')">å®Œäº† [7]</button>
                                <button onclick="copyTask('${d.id}')" style="margin-left:auto; border:none; background:none; cursor:pointer; font-size:13px;">è¤‡è£½ [7]</button>
                                <button onclick="delTask('${d.id}')" style="color:#ff4d4d; border:none; background:none; cursor:pointer; font-size:13px; margin-left:15px;">å‰Šé™¤ [7]</button>
                            </div>
                        </div>`;
                });
                document.getElementById('c-all').innerText = s.all;
                document.getElementById('c-un').innerText = s.un;
                document.getElementById('c-ing').innerText = s.ing;
                document.getElementById('c-fin').innerText = s.fin;
            });
        }

        window.upSt = async (id, st) => await updateDoc(doc(db, "tasks", id), { status: st });
        window.delTask = async (id) => { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) await deleteDoc(doc(db, "tasks", id)); };
        
        document.getElementById('t-mmdd').oninput = (e) => {
            if(e.target.value.length === 4) {
                const m = e.target.value.substring(0,2);
                const d = e.target.value.substring(2,4);
                document.getElementById('t-date').value = `2025-${m}-${d}`;
            }
        };

        window.showImport = () => document.getElementById('import-modal').classList.remove('hidden');
        document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => window.location.href="index.html");
    </script>
</body>
</html>
