<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¿ã‚¹ã‚¯ç®¡ç† - TaskFollow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --p: #5b50f2; --bg: #f8f9fc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: #333; }
        
        /* ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºãƒ»é…ç½®ä¿®æ­£ (ã‚½ãƒ¼ã‚¹ã€Œã‚ï¼’ã€æº–æ‹  [1]) */
        header { background: white; padding: 12px 60px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .h-btn { padding: 9px 18px; border-radius: 0.75rem; border: 1px solid #e5e7eb; background: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; font-family: inherit; }
        .h-btn-main { background: var(--p); color: white; border: none; padding: 11px 22px; }

        /* ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ [6] */
        .u-area { position: relative; cursor: pointer; font-weight: 700; margin-top: 5px; }
        .dropdown { display: none; position: absolute; top: 100%; left: 0; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 1rem; z-index: 1000; min-width: 240px; padding: 10px; margin-top: 10px; }
        .u-area:hover .dropdown { display: block; }
        .dropdown button { width: 100%; border: none; background: none; text-align: left; padding: 12px 15px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; border-radius: 0.5rem; font-family: inherit; }
        .dropdown button:hover { background: #f3f4f6; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å»ƒæ­¢ãƒ»ã‚«ã‚¹ã‚¿ãƒ UI) [7, 8] */
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 35px; border-radius: 1.5rem; z-index: 2000; box-shadow: 0 20px 80px rgba(0,0,0,0.2); width: 480px; }
        .hidden { display: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1999; }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 0.75rem; background: #fafafa; font-family: inherit; box-sizing: border-box; }
        #bulk-typing-area { height: 180px; font-family: monospace; } /* æŒ‡å®š: ç­‰å¹…ãƒ•ã‚©ãƒ³ãƒˆ [9] */

        /* ä¸€æ‹¬æ“ä½œãƒãƒ¼ [1] */
        .bulk-bar { display: none; background: var(--p); color: white; margin: 0 60px 20px; padding: 15px 25px; border-radius: 1rem; justify-content: space-between; align-items: center; }

        /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ [10] */
        .task-card { background: white; padding: 25px 30px; border-radius: 1.5rem; border: 1px solid #eee; margin: 0 60px 15px; }
        .st-btn { padding: 8px 22px; border-radius: 20px; border: 1px solid #eee; background: white; font-size: 13px; font-weight: 600; cursor: pointer; color: #999; margin-right: 10px; font-family: inherit; }
        .st-btn.active { background: var(--p); color: white; border-color: var(--p); }
    </style>
</head>
<body>
    <header>
        <div>
            <h2 style="margin:0; font-size:22px;">ã‚¿ã‚¹ã‚¯ç®¡ç†</h2>
            <div class="u-area"><span id="u-name">...</span> ã•ã‚“ <i class="fa-solid fa-chevron-down" style="font-size:10px;"></i>
                <div class="dropdown">
                    <button onclick="openEdit('email')"><i class="fa-solid fa-envelope"></i> ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´</button>
                    <button onclick="openEdit('phone')"><i class="fa-solid fa-phone"></i> é›»è©±ç•ªå·å¤‰æ›´</button>
                    <button onclick="openEdit('password')"><i class="fa-solid fa-key"></i> ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
                    <button onclick="openEdit('name')"><i class="fa-solid fa-user-pen"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´</button>
                    <button id="logout-btn" style="color:#ef4444; border-top:1px solid #f9f9f9; padding-top:15px;"><i class="fa-solid fa-right-from-bracket"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
        <div style="display:flex; gap:12px;">
            <button class="h-btn" onclick="openM('settings')"><i class="fa-solid fa-gear"></i> è¨­å®š</button>
            <button class="h-btn" onclick="openM('import')"><i class="fa-solid fa-file-import"></i> ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <button class="h-btn" onclick="openM('bulk')"><i class="fa-solid fa-list-check"></i> ä¸€æ‹¬ç™»éŒ²</button>
            <button class="h-btn h-btn-main" onclick="openM('new')"><i class="fa-solid fa-plus"></i> æ–°è¦ã‚¿ã‚¹ã‚¯</button>
        </div>
    </header>

    <div id="overlay" class="overlay hidden" onclick="closeAll()"></div>

    <!-- è¨­å®šãƒ»ã‚¿ã‚¹ã‚¯ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ä¸€å¼ -->
    <div id="edit-modal" class="modal hidden">
        <h3 id="edit-title">è¨­å®šã®æ›´æ–°</h3>
        <input type="text" id="edit-input" style="margin:20px 0;">
        <div style="display:flex; gap:12px;">
            <button onclick="closeAll()" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button id="edit-save-btn" style="flex:1; background:var(--p); color:white; font-weight:700;">æ›´æ–°ã™ã‚‹</button>
        </div>
    </div>

    <div id="new-modal" class="modal hidden">
        <h3 style="margin-top:0;">ã‚¿ã‚¹ã‚¯ã®ä½œæˆ [7]</h3>
        <input type="text" id="t-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" style="margin-bottom:15px;">
        <div style="display:flex; gap:12px; margin-bottom:15px;">
            <select id="t-pri"><option>é«˜</option><option selected>ä¸­</option><option>ä½</option></select>
            <input type="text" id="t-cat" placeholder="ã‚«ãƒ†ã‚´ãƒªãƒ¼">
        </div>
        <div style="background:#f9f9fc; padding:20px; border-radius:1.5rem; border:1px solid #eee;">
            <label style="font-weight:700;"><input type="checkbox" id="t-limit-on" checked> æœŸé™ã‚’è¨­ã‘ã‚‹ [11]</label>
            <input type="text" id="t-mmdd" placeholder="ã‚¹ãƒãƒ¼ãƒˆå…¥åŠ› (MMDD)" style="margin-top:15px;">
        </div>
        <button id="task-save-exec" style="width:100%; padding:16px; background:var(--p); color:white; border:none; border-radius:1rem; font-weight:700; margin-top:20px; cursor:pointer;">ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜</button>
    </div>

    <!-- ä¸€æ‹¬æ“ä½œãƒãƒ¼ [1] -->
    <div class="bulk-bar" id="bulk-ui">
        <div><button onclick="selectAll()">ã™ã¹ã¦é¸æŠ</button> <span id="sel-txt">0 ä»¶é¸æŠä¸­</span></div>
        <div style="display:flex; gap:10px;">
            <button onclick="bulkCopy()">ä¸€æ‹¬è¤‡è£½</button>
            <button onclick="bulkDel()" style="background:#ff4d4d; border:none;">ä¸€æ‹¬å‰Šé™¤</button>
        </div>
    </div>

    <div id="task-list" style="padding-top:20px;"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const app = initializeApp({ apiKey: "AIzaSyBV5WcWYSBUybd-Jv6iUnC80QNFAjMc5VU", authDomain: "taskfollow-b70ff.firebaseapp.com", projectId: "taskfollow-b70ff" });
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userNow = null;

        onAuthStateChanged(auth, async (u) => {
            if (!u) window.location.href = "index.html";
            userNow = u;
            // Googleãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯è¡¨ç¤ºåã‚’ã€ãƒ¡ãƒ¼ãƒ«æ™‚ã¯Firestoreã®å€¤ã‚’æ¡ç”¨ [12]
            const uDoc = await getDoc(doc(db, "users", u.uid));
            document.getElementById('u-name').innerText = (u.displayName || uDoc.data()?.displayName || "ãƒ¦ãƒ¼ã‚¶ãƒ¼");
            loadTasks();
        });

        // ä¿®æ­£: ã‚¿ã‚¹ã‚¯ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯
        document.getElementById('task-save-exec').onclick = async () => {
            const title = document.getElementById('t-title').value;
            if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            await addDoc(collection(db, "tasks"), {
                uid: userNow.uid, title, priority: document.getElementById('t-pri').value,
                category: document.getElementById('t-cat').value || "ãªã—",
                date: document.getElementById('t-mmdd').value || "æœŸé™ãªã—",
                status: "æœªç€æ‰‹", createdAt: new Date()
            });
            closeAll();
        };

        // ä¿®æ­£: è¨­å®šå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« [8, 9]
        window.openEdit = (field) => {
            const titles = { email: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´", phone: "é›»è©±ç•ªå·å¤‰æ›´", password: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´", name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´" };
            document.getElementById('edit-title').innerText = titles[field];
            document.getElementById('edit-input').type = (field === 'password') ? 'password' : 'text';
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('edit-modal').classList.remove('hidden');
            
            document.getElementById('edit-save-btn').onclick = async () => {
                const val = document.getElementById('edit-input').value;
                try {
                    if (field === 'email') await updateEmail(auth.currentUser, val);
                    if (field === 'password') await updatePassword(auth.currentUser, val);
                    const updateData = {};
                    if (field === 'name') updateData.displayName = val;
                    if (field === 'phone') updateData.phone = val;
                    if (Object.keys(updateData).length > 0) await updateDoc(doc(db, "users", userNow.uid), updateData);
                    alert("æ›´æ–°å®Œäº†");
                    location.reload();
                } catch (e) { alert(e.message); }
            };
        };

        window.openM = (t) => {
            document.getElementById('overlay').classList.remove('hidden');
            if(t === 'new') document.getElementById('new-modal').classList.remove('hidden');
        };
        window.closeAll = () => document.querySelectorAll('.modal, .overlay').forEach(el => el.classList.add('hidden'));

        function loadTasks() {
            const q = query(collection(db, "tasks"), where("uid", "==", userNow.uid));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('task-list');
                list.innerHTML = snap.empty ? '<p style="text-align:center; color:#888;">ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ [6]</p>' : '';
                snap.forEach(d => {
                    const t = d.data();
                    list.innerHTML += `
                        <div class="task-card">
                            <h3 style="margin:0 0 15px;"><input type="checkbox" onchange="upBulk()"> ${t.title}</h3>
                            <div style="margin-bottom:20px; font-size:13px; color:#888; display:flex; gap:20px;">
                                <span><i class="fa-solid fa-flag" style="color:#ff4d4d; margin-right:5px;"></i>${t.priority}</span>
                                <span style="background:#f0efff; color:var(--p); padding:3px 10px; border-radius:6px; font-weight:700;">${t.category}</span>
                                <span>ğŸ•’ ${t.date}</span>
                            </div>
                            <button class="st-btn ${t.status=='æœªç€æ‰‹'?'active':''}" onclick="upSt('${d.id}','æœªç€æ‰‹')">æœªç€æ‰‹</button>
                            <button class="st-btn ${t.status=='é€²è¡Œä¸­'?'active':''}" onclick="upSt('${d.id}','é€²è¡Œä¸­')">é€²è¡Œä¸­</button>
                            <button class="st-btn ${t.status=='å®Œäº†'?'active':''}" onclick="upSt('${d.id}','å®Œäº†')">å®Œäº†</button>
                        </div>`;
                });
            });
        }

        window.upSt = async (id, st) => await updateDoc(doc(db, "tasks", id), { status: st });
        window.upBulk = () => {
            const n = document.querySelectorAll('input[type="checkbox"]:checked').length;
            document.getElementById('bulk-ui').style.display = n > 0 ? 'flex' : 'none';
            document.getElementById('sel-txt').innerText = `${n} ä»¶é¸æŠä¸­ [1]`;
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);
    </script>
</body>
</html>
