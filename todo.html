<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>タスク管理 - TaskFollow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        :root { --p: #5b50f2; --bg: #f8f9fc; --gray: #718096; }
        body { font-family: 'Inter', "Yu Gothic", sans-serif; background: var(--bg); margin: 0; color: #1a202c; }

        /* ヘッダー UI [ソース あ２] */
        header { background: white; padding: 15px 60px; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: flex-start; }
        .u-area { position: relative; cursor: pointer; font-weight: 700; font-size: 14px; margin-top: 5px; }
        .h-btns { display: flex; gap: 10px; margin-top: 5px; }
        .h-btn { padding: 9px 18px; border-radius: 0.75rem; border: 1px solid #e2e8f0; background: white; font-weight: 600; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .h-btn-main { background: var(--p); color: white; border: none; padding: 11px 22px; }

        /* 統計カード [ソース あ２] */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 25px 60px; }
        .stat-card { background: white; padding: 22px; border-radius: 1.5rem; border: 1px solid #edf2f7; display: flex; align-items: center; gap: 15px; }

        /* タスク作成モーダル [ソース jpeg 44] */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; backdrop-filter: blur(4px); }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 35px; border-radius: 2rem; z-index: 1001; display: none; width: 500px; box-shadow: 0 30px 100px rgba(0,0,0,0.2); }
        .modal h3 { margin: 0 0 20px; font-size: 20px; font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
        .modal input, .modal select, .modal textarea { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 0.85rem; margin-bottom: 15px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        
        /* 期限セクション [画像 44 の再現] */
        .date-section { background: #f8fafc; padding: 20px; border-radius: 1.25rem; border: 1px solid #edf2f7; margin-bottom: 15px; }
        .date-section label { font-weight: 800; display: block; margin-bottom: 10px; font-size: 13px; color: #1a202c; }
        .date-sub { font-size: 11px; color: #a0aec0; margin-bottom: 5px; font-weight: 700; }
        #t-mmdd { margin-bottom: 15px; }
        #t-picker-box { background: #edf2f7; border-radius: 8px; height: 40px; }

        .modal-btns { display: flex; gap: 15px; margin-top: 10px; }
        .m-btn-c { flex: 1; padding: 14px; border-radius: 12px; border: none; background: #edf2f7; font-weight: 800; cursor: pointer; color: #4a5568; }
        .m-btn-s { flex: 1; padding: 14px; border-radius: 12px; border: none; background: var(--p); color: white; font-weight: 800; cursor: pointer; }

        /* タスクカード [画像 46, 49] */
        .task-card { background: white; padding: 25px 30px; border-radius: 1.5rem; border: 1px solid #edf2f7; margin: 0 60px 15px; }
        .st-btn { padding: 7px 18px; border-radius: 15px; border: 1px solid #edf2f7; background: #f8fafc; font-size: 12px; font-weight: 800; cursor: pointer; color: var(--gray); margin-right: 8px; }
        .st-btn.active { background: var(--p); color: white; border-color: var(--p); }
    </style>
</head>
<body>
    <header>
        <div>
            <h2>タスク管理</h2>
            <div class="u-area">
                <!-- 修正：アカウント名表示バグの修正 -->
                <span id="u-display">...</span> さん <i class="fa-solid fa-chevron-down"></i>
            </div>
        </div>
        <div class="h-btns">
            <button class="h-btn"><i class="fa-solid fa-gear"></i> 設定</button>
            <button class="h-btn-main h-btn" onclick="openM()"><i class="fa-solid fa-plus"></i> 新規タスク</button>
        </div>
    </header>

    <div id="list-target"></div>

    <div id="overlay" class="overlay" onclick="closeM()"></div>

    <!-- 修正：タスク作成モーダル UI [画像 44 準拠] -->
    <div id="new-modal" class="modal">
        <h3>タスク作成 <i class="fa-solid fa-xmark" onclick="closeM()" style="cursor:pointer; color:#cbd5e0;"></i></h3>
        <input type="text" id="t-title" placeholder="タスク名を入力...">
        <div style="display:flex; gap:12px;">
            <select id="t-pri"><option value="高">優先度: 高</option><option value="中" selected>優先度: 中</option><option value="低">優先度: 低</option></select>
            <select id="t-cat"><option value="仕事">仕事</option><option value="プライベート">プライベート</option></select>
        </div>
        <div class="date-section">
            <label><input type="checkbox" id="t-has-date" checked> 期限を設ける</label>
            <div class="date-sub">スマート入力 (MMDD)</div>
            <input type="text" id="t-mmdd" placeholder="例: 0520">
            <div class="date-sub">カレンダーから選択</div>
            <input type="date" id="t-picker">
        </div>
        <textarea id="t-memo" placeholder="詳細メモ..." style="height:100px;"></textarea>
        <div class="modal-btns">
            <button class="m-btn-c" onclick="closeM()">キャンセル</button>
            <button class="m-btn-s" id="btn-save">保存</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const app = initializeApp({ apiKey: "AIzaSyBV5WcWYSBUybd-Jv6iUnC80QNFAjMc5VU", authDomain: "taskfollow-b70ff.firebaseapp.com", projectId: "taskfollow-b70ff" });
        const auth = getAuth(app), db = getFirestore(app);
        let userNow = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) { window.location.href = "index.html"; return; }
            userNow = user;
            // 修正：ログイン成功時のプロフィール情報からアカウント名を表示 [4]
            document.getElementById('u-display').innerText = user.displayName || "ユーザー";
            listenTasks();
        });

        // 修正：タスク追加バグの修正（Firestoreへの確実な保存）
        document.getElementById('btn-save').onclick = async () => {
            const title = document.getElementById('t-title').value.trim();
            if (!title) return alert("タスク名を入力してください");

            let dateVal = "期限なし";
            if (document.getElementById('t-has-date').checked) {
                const mmdd = document.getElementById('t-mmdd').value;
                dateVal = (mmdd.length === 4) ? `${new Date().getFullYear()}-${mmdd.slice(0,2)}-${mmdd.slice(2,4)}` : document.getElementById('t-picker').value;
            }

            try {
                await addDoc(collection(db, "tasks"), {
                    uid: userNow.uid,
                    title,
                    priority: document.getElementById('t-pri').value,
                    category: document.getElementById('t-cat').value,
                    date: dateVal || "期限なし",
                    status: "未着手",
                    createdAt: new Date()
                });
                closeM();
            } catch (e) { alert("保存に失敗しました。"); }
        };

        function listenTasks() {
            onSnapshot(query(collection(db, "tasks"), where("uid", "==", userNow.uid)), (snap) => {
                const target = document.getElementById('list-target');
                target.innerHTML = snap.docs.map(d => `
                    <div class="task-card">
                        <div class="task-title"><b>${d.data().title}</b></div>
                        <div style="font-size:12px; color:#718096; margin:10px 0;">旗 ${d.data().priority} | ${d.data().category} | 期限: ${d.data().date}</div>
                        <button class="st-btn active">未着手</button><button class="st-btn">進行中</button><button class="st-btn">完了</button>
                    </div>`).join('');
            });
        }

        window.openM = () => { document.getElementById('overlay').style.display = document.getElementById('new-modal').style.display = 'block'; };
        window.closeM = () => { document.getElementById('overlay').style.display = document.getElementById('new-modal').style.display = 'none'; };
    </script>
</body>
</html>
