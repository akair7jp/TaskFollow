<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>タスク管理 - TaskFollow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        :root { --p: #5b50f2; --bg: #f8f9fc; --gray: #718096; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; color: #1a202c; }

        header { background: white; padding: 15px 60px; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: flex-start; }
        .u-area { position: relative; cursor: pointer; font-weight: 700; font-size: 14px; }
        .dropdown { display: none; position: absolute; top: 100%; left: 0; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 1rem; padding: 10px; min-width: 220px; z-index: 100; }
        .u-area:hover .dropdown { display: block; }
        .h-btns { display: flex; gap: 10px; }
        .h-btn { padding: 9px 18px; border-radius: 0.75rem; border: 1px solid #e2e8f0; background: white; font-weight: 600; cursor: pointer; font-size: 14px; }
        .h-btn-main { background: var(--p); color: white; border: none; }

        /* 新規タスク作成 UI [5][6] */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; backdrop-filter: blur(4px); }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 35px; border-radius: 2rem; z-index: 1001; display: none; width: 480px; box-shadow: 0 30px 100px rgba(0,0,0,0.2); }
        .modal h3 { margin: 0 0 20px; font-size: 20px; font-weight: 800; display: flex; justify-content: space-between; }
        .modal input, .modal select, .modal textarea { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 0.85rem; margin-bottom: 15px; box-sizing: border-box; font-family: inherit; }
        
        .date-section { background: #f8fafc; padding: 20px; border-radius: 1.25rem; border: 1px solid #edf2f7; margin-bottom: 15px; }
        .date-section label { font-weight: 800; display: block; margin-bottom: 10px; font-size: 13px; }
        .date-sub { font-size: 11px; color: #a0aec0; margin-bottom: 5px; font-weight: 700; }

        .modal-btns { display: flex; gap: 15px; }
        .m-btn-c { flex: 1; padding: 14px; border-radius: 12px; border: none; background: #edf2f7; font-weight: 800; cursor: pointer; }
        .m-btn-s { flex: 1; padding: 14px; border-radius: 12px; border: none; background: var(--p); color: white; font-weight: 800; cursor: pointer; }
        
        .task-card { background: white; padding: 25px 30px; border-radius: 1.5rem; border: 1px solid #edf2f7; margin: 15px 60px; }
    </style>
</head>
<body>
    <header>
        <div>
            <h2 style="margin:0;">タスク管理</h2>
            <div class="u-area">
                <!-- 修正：アカウント名の表示バグ [4] -->
                <span id="u-display">...</span> さん <i class="fa-solid fa-chevron-down"></i>
                <div class="dropdown">
                    <button onclick="signOutAuth()">ログアウト</button>
                </div>
            </div>
        </div>
        <div class="h-btns">
            <button class="h-btn" onclick="openM()">+ 新規タスク</button>
        </div>
    </header>

    <div id="list-target"></div>

    <div id="overlay" class="overlay" onclick="closeM()"></div>

    <!-- 修正：新規タスク作成 UI [5-7] -->
    <div id="new-modal" class="modal">
        <h3>タスク作成 <i class="fa-solid fa-xmark" onclick="closeM()" style="cursor:pointer; color:#cbd5e0;"></i></h3>
        <input type="text" id="t-title" placeholder="タスク名を入力...">
        <div style="display:flex; gap:12px;">
            <select id="t-pri"><option>優先度: 高</option><option selected>優先度: 中</option><option>優先度: 低</option></select>
            <select id="t-cat"><option>仕事</option><option>プライベート</option></select>
        </div>
        <div class="date-section">
            <label><input type="checkbox" id="t-has-date" checked> 期限を設ける</label>
            <div class="date-sub">スマート入力 (MMDD)</div>
            <input type="text" id="t-mmdd" placeholder="例: 0520">
            <div class="date-sub">カレンダーから選択</div>
            <input type="date" id="t-picker">
        </div>
        <textarea id="t-memo" placeholder="詳細メモ..." style="height:100px;"></textarea>
        <div class="modal-btns">
            <button class="m-btn-c" onclick="closeM()">キャンセル</button>
            <button class="m-btn-s" id="btn-save">保存</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const app = initializeApp({ apiKey: "AIzaSyBV5WcWYSBUybd-Jv6iUnC80QNFAjMc5VU", authDomain: "taskfollow-b70ff.firebaseapp.com", projectId: "taskfollow-b70ff" });
        const auth = getAuth(app), db = getFirestore(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) { window.location.href = "index.html"; return; }
            currentUser = user;
            // 修正：アカウント名の表示バグ（Authプロフィールの優先利用）[4]
            document.getElementById('u-display').innerText = user.displayName || "ユーザー";
            listenTasks();
        });

        // 修正：タスク追加機能の不具合修正 [8, 9]
        document.getElementById('btn-save').onclick = async () => {
            const title = document.getElementById('t-title').value.trim();
            if (!title) return alert("タイトルを入力してください");

            let dateVal = "期限なし";
            if (document.getElementById('t-has-date').checked) {
                const mmdd = document.getElementById('t-mmdd').value;
                dateVal = (mmdd.length === 4) ? `${new Date().getFullYear()}-${mmdd.slice(0,2)}-${mmdd.slice(2,4)}` : document.getElementById('t-picker').value;
            }

            try {
                await addDoc(collection(db, "tasks"), {
                    uid: currentUser.uid,
                    title,
                    priority: document.getElementById('t-pri').value,
                    category: document.getElementById('t-cat').value,
                    date: dateVal || "期限なし",
                    status: "未着手",
                    createdAt: new Date()
                });
                closeM();
            } catch (e) { alert("追加に失敗しました。"); }
        };

        function listenTasks() {
            onSnapshot(query(collection(db, "tasks"), where("uid", "==", currentUser.uid)), (snap) => {
                const target = document.getElementById('list-target');
                target.innerHTML = snap.docs.map(d => `<div class="task-card"><b>${d.data().title}</b><br><small>${d.data().date}</small></div>`).join('');
            });
        }

        window.openM = () => { document.getElementById('overlay').style.display = document.getElementById('new-modal').style.display = 'block'; };
        window.closeM = () => { document.getElementById('overlay').style.display = document.getElementById('new-modal').style.display = 'none'; };
        window.signOutAuth = () => signOut(auth);
    </script>
</body>
</html>
